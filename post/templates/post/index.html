<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
  <style>
    @charset "utf-8";
    /***
          The new CSS reset - version 1.8.5 (last updated 14.6.2023)
          GitHub page: https://github.com/elad2412/the-new-css-reset
      ***/

    /*
          Remove all the styles of the "User-Agent-Stylesheet", except for the 'display' property
          - The "symbol *" part is to solve Firefox SVG sprite bug
          - The "html" attribute is exclud, because otherwise a bug in Chrome breaks the CSS hyphens property (https://github.com/elad2412/the-new-css-reset/issues/36)
       */
    *:where( :not(html, iframe, canvas, img, svg, video, audio):not(svg *,
        symbol *)) {
      all: unset;
      display: revert;
    }

    /* Preferred box-sizing value */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    /* Reapply the pointer cursor for anchor tags */
    a,
    button {
      cursor: revert;
    }

    /* Remove list styles (bullets/numbers) */
    ol,
    ul,
    menu {
      list-style: none;
    }

    /* For images to not be able to exceed their container */
    img {
      max-inline-size: 100%;
      max-block-size: 100%;
    }

    /* removes spacing between cells in tables */
    table {
      border-collapse: collapse;
    }

    /* Safari - solving issue when using user-select:none on the <body> text input doesn't working */
    input,
    textarea {
      -webkit-user-select: auto;
    }

    /* revert the 'white-space' property for textarea elements on Safari */
    textarea {
      white-space: revert;
    }

    /* minimum style to allow to style meter element */
    meter {
      -webkit-appearance: revert;
      appearance: revert;
    }

    /* preformatted text - use only for this feature */
    :where(pre) {
      all: revert;
    }

    /* reset default text opacity of input placeholder */
    ::placeholder {
      color: unset;
    }

    /* remove default dot (•) sign */
    ::marker {
      content: initial;
    }

    /* fix the feature of 'hidden' attribute.
         display:revert; revert to element instead of attribute */
    :where([hidden]) {
      display: none;
    }

    /* revert for bug in Chromium browsers
         - fix for the content editable attribute will work properly.
         - webkit-user-select: auto; added for Safari in case of using user-select:none on wrapper element */
    :where([contenteditable]:not([contenteditable="false"])) {
      -moz-user-modify: read-write;
      -webkit-user-modify: read-write;
      overflow-wrap: break-word;
      -webkit-line-break: after-white-space;
      -webkit-user-select: auto;
    }

    /* apply back the draggable feature - exist only in Chromium and Safari */
    :where([draggable="true"]) {
      -webkit-user-drag: element;
    }

    /* Revert Modal native behavior */
    :where(dialog:modal) {
      all: revert;
    }
    .mapContainer {
      /* position: relative; */
      /* top: 51px; */
      margin-bottom: 50px;
      padding: 2rem;
    }
    .mapContainer::before {
      width: 100%;
      height: 50px;
      content: "세계지도에 목적지를 표시하세요!";
      display: block;
      background-color: #43a1ff;
      color: #fff;
      line-height: 50px;
      text-align: center;
    }
    #map {
      width: 100%;
      height: 350px;
    }
    .header {
      width: 100%;
      height: 55px;
      z-index: 999;
      background: #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgb(226, 226, 226);
      padding: 0 2rem;
      position: sticky;
      top: 0;
      box-shadow: rgba(50, 50, 93, 0.25) 0px 50px 100px -20px, rgba(0, 0, 0, 0.3) 0px 30px 60px -30px;
    }
    .header > p {
      font-weight: bold;
    }
    .inputBox {
      display: flex;
      padding: 10px 0;
    }
    .inputBox > a {
      width: 100px;
      height: 40px;
      line-height: 40px;
      text-align: center;
      margin-right: 10px;
    }
    .inputBox > a:hover {
      font-weight: bold;
    }
    .inputBox form {
      background: #002c58;
      width: 100px;
      height: 40px;
      line-height: 40px;
      text-align: center;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      border-radius: 3px;
    }
    .inputBox > form:hover {
      background-color: #76bbff
    }
    .icon {
      display: flex;
      /* justify-content: center; */
      /* align-content: center; */
      padding: 15px 0;
    }
    .icon::before {
        content: "";
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: url('https://velog.velcdn.com/images/duboo/post/3de198f6-fc76-4b47-b2f1-a2200e7c0195/image.png');
        background-repeat: no-repeat;
        background-size: cover;
    }

    .userAndTime {
      margin-left: 10px;
    }
    .userName {
      font-weight: bold;
      font-size: 18px;
    }
    .createdAt {
      color: #5c5c5c;
    }
    .contents {
      border-bottom: 1px solid black;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .contents-container {
      width: 100%;
      display: flex;
      justify-content: center;
      flex-direction: column;
      align-items: center;
    }
    .contents-box {
      border-bottom: 1px solid black;
      margin-bottom: 10px;
      padding-bottom: 10px;
      box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
      padding: 1rem;
      width: 600px;
      position: relative;
      margin-bottom: 60px;
    }
    .imgBox {
      width: calc(600px - 2rem);
      height: 380px;
    }
    .imgBox img {
      width: calc(600px - 2rem);
      height: 380px;
      background-size: cover;
      background-repeat: no-repeat;
    }
    .countryAndCity {
      position: absolute;
      width: calc(600px - 2rem);
      height: 50px;
      top: 425px;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      background: black;
      color: #fff;
      padding: 0 1rem;
      opacity: .5;
    }
    .countryAndCity p {
      opacity: none;
    }
    .country {
      font-weight: bold;
      font-size: 20px;
      margin-right: 10px;
    }
    .city {
      font-size: 17px;
    }
    .content {
      border-bottom: 1px solid rgb(219, 219, 219);
      padding: 10px 10px 20px;
      margin-bottom: 10px;
    }
    .textBox {
      width: 100%;
      padding: 0 5px;
      margin-top: 20px;
    }
    .textBox .textBox_input {
      width: 80%;
      background: rgb(241, 241, 241);
      height: 35px;
      line-height: 35px;
      padding: 0 5px;
    }
    .textBox .textBox_btn {
      width: 19%;
      height: 35px;
      background: #002c58;
      text-align: center;
      color: #fff;
      line-height: 35px;
      font-weight: bold;
    }
    ul > li > div {
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <div class="header">
    {% if user.is_authenticated %}
    <p>반갑습니다 {{user}} 님</p>
    <div class="inputBox">
      <a href="/post/create/">게시글 작성</a>
      <form action="/accounts/logout/" method="post">
        {% csrf_token %} <input type="submit" value="로그아웃" />
      </form>
    </div>

    {% else %}
    <a href="/accounts/login/"> 로그인하기 </a>
    <a href="/accounts/signup/"> 회원가입하기 </a>
    {% endif %} 
  </div>

  <div class="mapContainer">
    <div id="map"></div>
  </div>
  <div class="contents-container">

  </div>
      {% for post in post %} {% if post.image %}
    <div class="icon">
      <div class="userAndTime">
        <p class="userName">{{post.user}}</p>
        <p class="createdAt">{{post.created_at}}</p>
      </div>
    </div>
    <a class="imgBox" href="/post/{{post.id}}/">
      <img src="{{ post.image.url }}" alt="게시물 이미지" />
    </a>
    {% else %}
    <a class="imgBox" href="/post/{{post.id}}/">
      <img src="/Users/jisukim/Desktop/onestone/media/images/IMG_0115.jpg" alt="게시물 이미지" />
    </a>
    {% endif %}

    <div class="countryAndCity">
      <p class="country">{{post.country}}</p>
      <p class="city">{{post.city}}</p>
    </div>
    <p class="content">{{post.content}}</p>
    <ul>
      {% for i in post.comment_set.all %}
      <li>
        <div>{{ i.content }}</div>
      </li>
      {% endfor %}
    </ul>
      <form class="textBox" action="/post/{{post.id}}/" method="post">
        {% csrf_token %}
        <input class="textBox_input" type="text" name="comment_form" placeholder="여행 사진에 댓글을 달아주세요!" />
        <input class="textBox_btn" type="submit" value="작성" />
      </form>
      {% endfor %}

      {% if user == post.user %}
      <form action="/post/{{ post.id }}/delete/" method="post">
        {% csrf_token %}
        <input type="submit" value="Delete">
      </form>
      {% endif %}

</body>
<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBA3n_VFf0kcGIh878nU1I8OOg6mZCCFbI&callback=initMap&libraries=maps,marker&v=beta"></script>
<script defer>
  // ------------------------------- db에서 가져온 유저 정보 -------------------------------
  const allUserName = document.querySelectorAll(".userName");
  const allCountry = document.querySelectorAll(".country");
  const allCity = document.querySelectorAll(".city");
  const allContents = document.querySelectorAll(".content");

  const countryLatLng = [
    { 한국: [35.9078, 127.7669] },
    { 대한민국: [35.9078, 127.7669] },
    { 일본: [36.2048, 138.2529] },
    { 중국: [35.8617, 104.1954] },
    { 미국: [37.0902, 95.7129] },
    { 영국: [55.3781, 3.436] },
    { 캐나다: [56.1304, 106.3468] },
    { 태국: [15.87, 100.9925] },
    { 독일: [51.1657, 10.4515] },
    { 멕시코: [23.6345, 102.5528] },
    { 터키: [38.9637, 35.2433] },
    { 이탈리아: [41.8719, 12.5674] },
    { 스페인: [40.4637, 3.7492] },
    { 프랑스: [46.2276, 2.2137] },
    { 오스트리아: [47.5162, 14.5501] },
    { 그리스: [39.0742, 21.8243] },
    { 튀르키예: [38.9637, 35.2433] },
  ];

  const userCnt = allUserName.length;

  // 모든 유저 정보가 담기는 객체
  const allUserInfo = [];

  for (let i = 0; i < userCnt; i++) {
    let userInfo = {};

    userInfo["user"] = allUserName[i].innerText;
    userInfo["country"] = allCountry[i].innerText;
    userInfo["city"] = allCity[i].innerText;
    userInfo["content"] = allContents[i].innerText;

    allUserInfo.push(userInfo);
  }

  allUserInfo.forEach((user) => {
    countryLatLng.forEach((countryVal) => {
      if (countryVal[user.country]) {
        user["lat"] = countryVal[user.country][0];
        user["lng"] = countryVal[user.country][1];
      }
    });
  });

  console.log("유저카운트: ", userCnt);
  console.log("모든 유저 정보 객체: ", allUserInfo);

  // reverse geocode map api
  window.initMap = function () {
    const map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 37.5519, lng: 126.9918 },
      zoom: 5,
    });

    const bounds = new google.maps.LatLngBounds();
    const infoWindow = new google.maps.InfoWindow();

    allUserInfo.forEach(({ user, country, content, lat, lng }) => {
      const marker = new google.maps.Marker({
        position: { lat, lng },
        label: user,
        map,
      });
      bounds.extend(marker.position);

      marker.addListener("click", () => {
        map.panTo(marker.position);
        infoWindow.setContent(content);
        infoWindow.open({
          anchor: marker,
          map,
        });
      });
    });
    map.fitBounds(bounds);
  };
  // style
  const iconEl = document.querySelectorAll('.icon');
  const imgEl = document.querySelectorAll('.imgBox');
  const countryEl = document.querySelectorAll('.countryAndCity');
  // const cityEl = document.querySelectorAll('.city');
  const contentEl = document.querySelectorAll('.content');
  const ulEl = document.querySelectorAll('ul');
  const textBoxEl = document.querySelectorAll('.textBox');
  

  for(let i=0; i<userCnt; i++) {
    const contentsBox = document.createElement("div");
    contentsBox.append(iconEl[i])
    contentsBox.append(imgEl[i])
    contentsBox.append(countryEl[i])
    // contentsBox.append(cityEl[i])e
    contentsBox.append(contentEl[i])
    contentsBox.append(ulEl[i])
    contentsBox.append(textBoxEl[i])

    contentsBox.classList.add('contents-box')

    document.querySelector('.contents-container').append(contentsBox)
  }
</script>
</body>

</html>